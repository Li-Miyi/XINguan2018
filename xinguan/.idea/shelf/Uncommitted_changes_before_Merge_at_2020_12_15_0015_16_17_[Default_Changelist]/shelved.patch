Index: jianyue/view/lifashi_yonghu.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>\r\n\r\n# Create your views here.\r\nfrom django.db.models import Sum\r\nfrom django.db.models.functions import ExtractMonth\r\nfrom django.http import JsonResponse,HttpResponse\r\nfrom django.utils import timezone\r\nfrom ..models import yonghu, lifashi, lifadian, fuwu, EmailVerifyRecord,jiesuandingdan, pingjia, dingdan, jishiqitadizhi, faxing, tupian, \\\r\n    yuyuedingdan, shoucang, dizhi, zixun, mibao\r\nfrom django.db.utils import IntegrityError\r\nfrom django.core.exceptions import ObjectDoesNotExist\r\nfrom django.views.decorators.csrf import csrf_exempt\r\n\r\n\r\n\"\"\"用户与理发师\"\"\"\r\n\r\n@csrf_exempt\r\ndef zhuce(request):\r\n    if request.method == \"POST\":\r\n        data_getter = request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter = request.GET\r\n    else:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"注册失败\"})\r\n    shenfen = data_getter.get('shenfen')\r\n    print(data_getter.get('mima'))\r\n    try:\r\n        if shenfen == 'lifashi':\r\n                print(\"lifashi\")\r\n                xingming = data_getter.get('xingming')\r\n                mima = data_getter.get('mima')\r\n                lianxifangshi = data_getter.get('lianxifangshi')\r\n                xingbie = data_getter.get('xingbie')\r\n                yonghuming = data_getter.get('yonghuming')\r\n                lifadian_id = data_getter.get('lifadian_id')\r\n                email = data_getter.get('email')\r\n                lifashi.objects.create(xingming=xingming, yonghuming=yonghuming, mima=mima,\r\n                                       lianxidianhua=int(lianxifangshi), xingbie=xingbie, lifadian_id=lifadian_id, email=email)\r\n        elif shenfen == 'yonghu':\r\n                print(\"yonghu\")\r\n                xingming = data_getter.get('xingming')\r\n                mima = data_getter.get('mima')\r\n                lianxifangshi = data_getter.get('lianxifangshi')\r\n                xingbie = data_getter.get('xingbie')\r\n                yonghuming = data_getter.get('yonghuming')\r\n                email = data_getter.get('email')\r\n                yonghu.objects.create(xingming=xingming, yonghuming=yonghuming, mima=mima, lianxidianhua=lianxifangshi,\r\n                                      xingbie=xingbie, email=email)\r\n        return JsonResponse({\"status\": 1, \"msg\": \"注册成功\"})\r\n    except IntegrityError:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"手机号码已注册\"})\r\n\r\n@csrf_exempt\r\ndef denglu(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    lianxifangshi = datagetter.get(\"lianxifangshi\")\r\n    mima = datagetter.get(\"mima\")\r\n    shenfen = datagetter.get(\"shenfen\")\r\n    if shenfen == \"lifashi\":\r\n        the_shenfen = lifashi\r\n    elif shenfen == \"yonghu\":\r\n        the_shenfen = yonghu\r\n    else:\r\n        return JsonResponse({'status': 3, 'msg': \"身份错误\"})\r\n    try:\r\n        this = the_shenfen.objects.get(lianxidianhua=lianxifangshi)\r\n    except yonghu.DoesNotExist:\r\n        return JsonResponse({'status': 0, 'msg': \"此用户不存在\"})\r\n    except lifashi.DoesNotExist:\r\n        return JsonResponse({'status': 0, 'msg': \"此用户不存在\"})\r\n    if this.mima != mima:\r\n        return JsonResponse({'status': 1, 'msg': \"密码错误\"})\r\n    else:\r\n        request.session['is_login'] = True  # 登录状态\r\n        request.session[\"tel\"] = lianxifangshi\r\n        request.session.set_expiry(14 * 24 * 3600)\r\n        print(\"COOKIES:\", request.COOKIES.items())\r\n        print(\"session:\", request.session.items())\r\n        return JsonResponse({'status': 2, 'msg': '登录成功'})\r\n\r\n\r\ndef xiugai(request):\r\n    if request.method == \"POST\":\r\n        data_getter = request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter = request.GET\r\n    else:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"访问方法错误\"})\r\n    ziduan = data_getter.get(\"ziduan\")\r\n    lianxifangshi = data_getter.get(\"lianxifangshi\")\r\n    neirong = data_getter.get(\"neirong\")\r\n    the_yonghu = yonghu.objects.filter(lianxidianhua=lianxifangshi)\r\n    data = {ziduan: neirong}\r\n    try:\r\n        the_yonghu.update(**data)\r\n    except TypeError:\r\n        return JsonResponse({\"status\": 0, \"msg\": \"字段错误\"})\r\n    except IntegrityError:\r\n        return JsonResponse({\"status\": 2, \"msg\": \"字段内容已被注册\"})\r\n    return JsonResponse({\"status\": 1, \"msg\": \"修改成功\"})\r\n\r\ndef xiugai_lfs(request):\r\n    if request.method == \"POST\":\r\n        data_getter=request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter=request.GET\r\n    else:\r\n        return  JsonResponse({\"success\": 0,\"msg\": \"访问方法错误\"})\r\n    ziduan=data_getter.get(\"ziduan\")\r\n    lianxifangshi=data_getter.get(\"lianxifangshi\")\r\n    neirong=data_getter.get(\"neirong\")\r\n    the_lifashi=lifashi.objects.filter(lianxidianhua=lianxifangshi)\r\n    data = {ziduan:neirong}\r\n    try:\r\n        the_lifashi.update(**data)\r\n    except TypeError:\r\n        return JsonResponse({\"status\": 0, \"msg\": \"字段错误\"})\r\n    except IntegrityError:\r\n        return JsonResponse({\"status\": 2, \"msg\": \"字段内容已被注册\"})\r\n    return JsonResponse({\"status\": 1, \"msg\": \"修改成功\"})\r\n\r\n\r\ndef liebiao(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    duixiang=datagetter.get('duixiang')\r\n    page=int(datagetter.get('page'))\r\n    pagesize=int(datagetter.get('pagesize'))\r\n    paixufangshi=datagetter.get('paixufangshi')\r\n    #理发师和理发店的所有数据\r\n    lifadian_datas = []\r\n    lifashi_datas = []\r\n    for i_lifadian in lifadian.objects.all():\r\n        lifadian_data = {\"name\": i_lifadian.dianming, \"id\": i_lifadian.pk}\r\n        i_lifadian_total_pingfen = 0\r\n        i_lifadian_total_jiage = 0\r\n        i_lifadian_count = 0\r\n        for i_lifashi in lifashi.objects.filter(lifadian=i_lifadian):\r\n            lifashi_data = {'id': i_lifashi.id, 'name': i_lifashi.xingming}\r\n            i_lifashi_total_pingfen = 0\r\n            i_lifashi_total_jiage = 0\r\n            i_lifashi_count = 0\r\n            for i_jiesuan in jiesuandingdan.objects.filter(lifashi=i_lifashi):\r\n                i_lifashi_count += 1\r\n                i_lifashi_total_jiage += i_jiesuan.shijifeiyong\r\n                try:\r\n                    for i_pingjia in pingjia.objects.filter(dingdan=i_jiesuan):\r\n                        i_lifashi_total_pingfen += i_pingjia.pingfen\r\n\r\n                except ObjectDoesNotExist:\r\n                    i_lifashi_total_pingfen += 5\r\n            try:\r\n                lifashi_data[\"price\"] = i_lifashi_total_jiage / i_lifashi_count\r\n            except:\r\n                lifashi_data[\"price\"] = 0\r\n            try:\r\n                lifashi_data[\"pingfen\"] = i_lifashi_total_pingfen / i_lifashi_count\r\n            except:\r\n                lifashi_data[\"pingfen\"] = 5\r\n            lifashi_datas.append(lifashi_data)\r\n            i_lifadian_total_pingfen += i_lifashi_total_pingfen\r\n            i_lifadian_total_jiage += i_lifashi_total_jiage\r\n            i_lifadian_count = i_lifashi_count\r\n        try:\r\n            lifadian_data[\"pingfen\"] = i_lifadian_total_pingfen / i_lifadian_count\r\n        except:\r\n            lifadian_data[\"pingfen\"] = 5\r\n        try:\r\n            lifadian_data[\"price\"] = i_lifadian_total_jiage / i_lifadian_count\r\n        except:\r\n            lifadian_data[\"price\"] = 0\r\n        lifadian_datas.append(lifadian_data)\r\n    #分页数据\r\n    if duixiang==\"lifashi\":\r\n        if paixufangshi=='价格最低':\r\n            lifashi_datas=jiageshengxu(lifashi_datas)\r\n        elif paixufangshi=='价格最高':\r\n            lifashi_datas=jiagejiangxu(lifashi_datas)\r\n        elif paixufangshi=='好评优先':\r\n            lifashi_datas==pingfenjiangxu(lifashi_datas)\r\n        else:\r\n            pass\r\n        lifashi_return=[]\r\n        if(len(lifashi_datas)%pagesize==0):\r\n            total_pages=len(lifashi_datas)//pagesize\r\n        else:\r\n            total_pages=len(lifashi_datas)//pagesize + 1\r\n        print((len((lifashi_datas))))\r\n        if(page<total_pages):\r\n            i=0\r\n            while(i<pagesize):\r\n                lifashi_return.append(lifashi_datas[i+(page-1)*pagesize])\r\n                i=i+1\r\n            return JsonResponse({\"lifashi\": lifashi_return, \"lifashihasMoreData\": True})\r\n        if(page>=total_pages):\r\n            i=0\r\n            while(i<len(lifashi_datas)-(page-1)*pagesize):\r\n                lifashi_return.append(lifashi_datas[i+(page-1)*pagesize])\r\n                i=i+1\r\n            return JsonResponse({\"lifashi\": lifashi_return, \"lifashihasMoreData\": False})\r\n    if duixiang==\"lifadian\":\r\n        if paixufangshi=='价格最低':\r\n            lifadian_datas=jiageshengxu(lifadian_datas)\r\n        elif paixufangshi=='价格最高':\r\n            lifadian_datas=jiagejiangxu(lifadian_datas)\r\n        elif paixufangshi=='好评优先':\r\n            lifadian_datas==pingfenjiangxu(lifadian_datas)\r\n        else:\r\n            pass\r\n        lifadian_return=[]\r\n        if(len(lifadian_datas)%pagesize==0):\r\n            total_pages=len(lifadian_datas)//pagesize\r\n        else:\r\n            total_pages=len(lifadian_datas)//pagesize + 1\r\n        print((len((lifadian_datas))))\r\n        if(page<total_pages):\r\n            i=0\r\n            while(i<pagesize):\r\n                lifadian_return.append(lifadian_datas[i+(page-1)*pagesize])\r\n                i=i+1\r\n            return JsonResponse({\"lifadian\": lifadian_return, \"lifadianhasMoreData\": True})\r\n        if(page>=total_pages):\r\n            i=0\r\n            while(i<len(lifadian_datas)-(page-1)*pagesize):\r\n                lifadian_return.append(lifadian_datas[i+(page-1)*pagesize])\r\n                i=i+1\r\n            return JsonResponse({\"lifadian\": lifadian_return, \"lifadianhasMoreData\": False})\r\n    # return JsonResponse({\"lifashi\": lifashi_datas, \"lifadian\": lifadian_datas})\r\n\r\n\r\ndef lifashi_detail(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    print(datagetter.get('lifashi_id'))\r\n    fuwuleixing = {\"1\":\"洗吹\",\"2\":\"烫发\",\"3\":\"染发\",\"4\":\"剪发\",\"5\":\"护理\"}\r\n    faxingleixing = {\"1\":\"短发\",\"2\":\"烫发\",\"3\":\"长发\",\"4\":\"染发\"}\r\n    the_lifashi = lifashi.objects.get(id=datagetter.get('lifashi_id'))\r\n    lifashi_id = the_lifashi.id\r\n    lifa_fuwu = []\r\n    lifashi_lifadian = []\r\n    lifashi_faxing = []\r\n    lifashi_pingjia = []\r\n    try:\r\n        i_lifashi = lifashi.objects.get(id=lifashi_id)\r\n    except lifashi.DoesNotExist:\r\n        return JsonResponse({\"status\": 0,\"msg\":\"id输入错误\"})\r\n    for i_fuwu in fuwu.objects.filter(lifashi=i_lifashi):\r\n        lifa_fuwu_detail = {\"fuwu_id\": i_fuwu.id, \"type\": fuwuleixing[i_fuwu.leixing], \"fuwu_name\": i_fuwu.fuwumingcheng,\r\n                                \"price\": i_fuwu.jiage}\r\n        lifa_fuwu.append(lifa_fuwu_detail)\r\n    for i_lifadian in lifadian.objects.filter(lifashi=i_lifashi):\r\n        try:\r\n            search_dict = {\"tupianleixing\": \"0\", \"tupianlaiyuan_id\":i_lifadian.id}\r\n            i_tupian = tupian.objects.filter(**search_dict).first()\r\n            src = str(i_tupian.src)\r\n        except:\r\n            src = \"../../image/0.jpg\"\r\n        lifadian_detail = {\"lifadian_id\": i_lifadian.id, \"lifadian_name\": i_lifadian.dianming, \"tupian\":src}\r\n        lifashi_lifadian.append(lifadian_detail)\r\n    for i_faxing in faxing.objects.filter(lifashi=i_lifashi):\r\n        try:\r\n            search_dict = {\"tupianleixing\": \"2\", \"tupianlaiyuan_id\": i_faxing.id}\r\n            i_tupian = tupian.objects.filter(**search_dict).first()\r\n            src = str(i_tupian.src)\r\n        except:\r\n            src = \"../../image/0.jpg\"\r\n        faxing_detail = {\"faxing_id\":i_faxing.id, \"faxingname\": i_faxing.faxingming, \"leixing\": faxingleixing[i_faxing.leixing],\"tupian\": src}\r\n        lifashi_faxing.append(faxing_detail)\r\n    for i_dingdan in dingdan.objects.filter(lifashi_id=lifashi_id):\r\n        for i_pingjia in pingjia.objects.filter(dingdan_id=i_dingdan.id):\r\n            lifashi_pingjia_detail = {'id': i_pingjia.id, \"pingfen\": i_pingjia.pingfen, \"pingjia\": i_pingjia.pingjia}\r\n            lifashi_pingjia.append(lifashi_pingjia_detail)\r\n    return JsonResponse(\r\n        {\"id\": i_lifashi.id, \"name\": i_lifashi.xingming, \"yonghuming\": i_lifashi.yonghuming,'phone': i_lifashi.lianxidianhua, \"fuwu\": lifa_fuwu,\r\n         \"lifadian\": lifashi_lifadian, \"faxing\":lifashi_faxing,\"pingjia\": lifashi_pingjia})\r\n\r\n# 返回不同的服务类型——用户端\r\ndef fuwuliebiao(request):  # 服务列表页\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    leixing = datagetter.get(\"leixing\")\r\n    fuwuliebiaos = fuwu.objects.filter(leixing=leixing)\r\n    fuwuliebiao = []\r\n    for fuwu_info in fuwuliebiaos:\r\n        try:\r\n            lifadian_name = fuwu_info.lifashi.lifadian.dianming  # 店名\r\n            jiage = fuwu_info.jiage  # 价格\r\n            fuwumingcheng = fuwu_info.fuwumingcheng  # 服务名称\r\n            dingdan_list = fuwu_info.dingdan_set.all()  # 反向查询所有的相关订单\r\n            pingfen_sum = 0  # 设定最初总分0\r\n            pingfen_num = 0  # 设定评分数量0\r\n            for dd in dingdan_list:\r\n                pingjia_list = dd.pingjia_set.all()  # 反向查询每一个订单的相关评价\r\n                for pj in pingjia_list:\r\n                    pingfen_sum = pingfen_sum + pj.pingfen\r\n                    pingfen_num = pingfen_num + 1\r\n            if pingfen_num == 0 and pingfen_sum == 0:\r\n                pingfen = 'null'\r\n            else:\r\n                pingfen = round(pingfen_sum / pingfen_num, 2)\r\n            fuwuliebiao.append(\r\n                {\"fuwu_id\": fuwu_info.id ,\"lifadian_name\": lifadian_name, \"jiage\": jiage, \"fuwumingcheng\": fuwumingcheng, \"leixing\": leixing,\r\n                 \"pingfen\": pingfen})\r\n        except Exception as e:\r\n            return JsonResponse({\"status\": 0, \"msg\": \"访问错误\"})\r\n    if len(fuwuliebiao) == 0:\r\n        return JsonResponse({\"status\": 5, \"msg\": \"请指定服务类型\"})\r\n    else:\r\n        return JsonResponse(fuwuliebiao, safe=False)\r\n\r\n#根据服务列表获得服务列表详情\r\ndef fuwuliebiaoxiangqing(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    try:\r\n        fuwu_id=datagetter.get(\"fuwu_id\")\r\n        fuwuxiangqing=fuwu.objects.get(id=fuwu_id) #获取服务实体\r\n        fw_leixing=fuwuxiangqing.get_leixing_display() #类型\r\n        fw_jiage=fuwuxiangqing.jiage #价格\r\n        fw_mingcheng=fuwuxiangqing.fuwumingcheng #名称\r\n        dingdan=fuwuxiangqing.dingdan_set.all() #反向查询每一个订单的相关评价\r\n        pingfen_sum = 0  # 设定最初总分0\r\n        pingfen_num = 0  # 设定评分数量0\r\n        for dd in dingdan:\r\n            pingjia_list = dd.pingjia_set.all()  # 反向查询每一个订单的相关评价\r\n            for pj in pingjia_list:\r\n                pingfen_sum = pingfen_sum + pj.pingfen\r\n                pingfen_num = pingfen_num + 1\r\n        if pingfen_num == 0 and pingfen_sum == 0:\r\n            pingfen = '暂无评价'\r\n        else:\r\n            pingfen = round(pingfen_sum / pingfen_num, 2)\r\n        fw_pingfen=pingfen #评分\r\n        fw_xingming=fuwuxiangqing.lifashi.xingming #理发师姓名\r\n        fw_xingbie=fuwuxiangqing.lifashi.get_xingbie_display()#理发师性别\r\n        fw_lianxidianhua=fuwuxiangqing.lifashi.lianxidianhua#理发师电话\r\n        lifashitupian=tupian.objects.filter(tupianlaiyuan_id=fuwuxiangqing.lifashi.id)[0]\r\n        fw_lifashi_image=str(lifashitupian.src)\r\n        fw_dianming=fuwuxiangqing.lifashi.lifadian.dianming#理发店名字\r\n        fw_dizhi=fuwuxiangqing.lifashi.lifadian.dizhi_set.all()[0].name#理发店地址\r\n        fw_dianzhulianxi=fuwuxiangqing.lifashi.lifadian.dianzhulianxi#店主联系方式\r\n        lifadiantupian=tupian.objects.filter(tupianlaiyuan_id=fuwuxiangqing.lifashi.lifadian.id)[0]\r\n        fw_lifadian_image=str(lifadiantupian.src)\r\n        result=JsonResponse({\"leixing\":fw_leixing,\"jiage\":fw_jiage,\"mingcheng\":fw_mingcheng,\"pingfen\":fw_pingfen,\r\n                             \"xingming\":fw_xingming,\"xingbie\":fw_xingbie,\"lianxidianhua\":fw_lianxidianhua,\r\n                             \"lifashi_image\":fw_lifashi_image,\"lifadian_image\":fw_lifadian_image,\"dianming\":fw_dianming,\r\n                             \"dizhi\":fw_dizhi,\"dianzhulianxi\":fw_dianzhulianxi})\r\n    except Exception as e:\r\n        result=JsonResponse({\"status\": 0, \"msg\": \"访问失败\",\"cuowu\":str(e)})\r\n    return result\r\n\r\n\r\n# 获取不同类型的发型库-用户端\r\ndef faxingList(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    faxing_c_id = int(datagetter.get('faxing_c_id')[0])\r\n    faxingList = []\r\n    faxing_leixing = {\"1\": \"短发\", \"2\": \"烫发\", \"3\": \"长发\", \"4\": \"染发\"}\r\n    for i_faxing in faxing.objects.filter(leixing=faxing_c_id):\r\n        imageList = []\r\n        for i_image in tupian.objects.filter(tupianlaiyuan_id=i_faxing.id):\r\n            if (i_image.tupianleixing == \"2\"):\r\n                imgae_detail = {\"image_id\": i_image.id, \"image_src\": str(i_image.src)}\r\n                imageList.append(imgae_detail)\r\n                faxing_detail = {\"id\": i_faxing.id, \"c_id\": i_faxing.leixing,\r\n                                 \"c_name\": faxing_leixing[i_faxing.leixing], \"f_name\": i_faxing.faxingming,\r\n                                 \"beizhu\": i_faxing.beizhu, \"image\": imageList}\r\n                faxingList.append(faxing_detail)\r\n    return JsonResponse(faxingList, safe=False)\r\n\r\n\r\n# 发型详情页面-用户端\r\ndef faxingDetail(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    faxing_id = int(datagetter.get('faxing_id')[0])\r\n    imageList = []\r\n    lifadianList = []\r\n    i_faxing = faxing.objects.get(id=faxing_id)\r\n    i_lifashi = lifashi.objects.get(id=i_faxing.lifashi_id)\r\n    lifashi_detail = {\"f_id\": i_lifashi.id, \"f_name\": i_lifashi.yonghuming, \"phone\": i_lifashi.lianxidianhua}\r\n    i_lifadian = lifadian.objects.get(id=i_lifashi.lifadian_id)\r\n    lifadian_detail = {\"s_id\": i_lifadian.id, \"s_name\": i_lifadian.dianming}\r\n    for i_image in tupian.objects.filter(tupianlaiyuan_id=faxing_id):\r\n        if (i_image.tupianleixing == \"2\"):\r\n            i_image_src = str(i_image.src)\r\n            imageList.append(i_image_src)\r\n    faxing_detail = {\"id\": faxing_id, \"c_id\": i_faxing.leixing, \"f_name\": i_faxing.faxingming,\r\n                     \"beizhu\": i_faxing.beizhu, \"image\": imageList, \"lifashi\": lifashi_detail, \"lifadian\": lifadian_detail}\r\n    return JsonResponse(faxing_detail)\r\n\r\n\r\n# 获取用户信息-用户端\r\ndef yonghuDetail(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    yonghu_detail = {}\r\n    sex = {\"0\":\"女\",\"1\":\"男\"}\r\n    lianxifangshi = datagetter.get(\"lianxifangshi\")\r\n    i_yonghu = yonghu.objects.get(lianxidianhua=lianxifangshi)\r\n    yonghu_id = i_yonghu.id\r\n    try:\r\n        yonghu_detail = {\"id\": i_yonghu.id, \"yonghuming\": i_yonghu.yonghuming, \"xingming\": i_yonghu.xingming,\r\n                \"sex\": sex[i_yonghu.xingbie]}\r\n        return JsonResponse(yonghu_detail)\r\n    except:\r\n        return JsonResponse({\"status\": 0,\"msg\": \"用户信息调取失败\"})\r\n    # for i_image in tupian.objects.filter(tupianlaiyuan_id=yonghu_id):\r\n    #     print(i_image.tupianleixing)\r\n    #     try:\r\n    #         if (i_image.tupianleixing == \"3\"):\r\n    #             yonghu_detail = {\"id\": i_yonghu.id, \"yonghuming\": i_yonghu.yonghuming, \"xingming\": i_yonghu.xingming,\r\n    #                              \"sex\": sex[i_yonghu.xingbie], \"touxiang\": str(i_image.src)}\r\n    #     except:\r\n    #         yonghu_detail = {\"id\": i_yonghu.id, \"yonghuming\": i_yonghu.yonghuming, \"xingming\": i_yonghu.xingming,\r\n    #                          \"sex\": sex[i_yonghu.xingbie], \"touxiang\": \"../../pages/image/默认头像.png\"}\r\n\r\n\r\n# 理发师注册页面获取理发店名-理发师端\r\ndef getLifadianName(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    lifadianList = []\r\n    for i_lifadian in lifadian.objects.all():\r\n        i_lifadian_name = i_lifadian.dianming\r\n        i_lifadian_id = i_lifadian.id\r\n        s_lifadian = {\"i_name\": i_lifadian_name, \"id\": i_lifadian_id}\r\n        lifadianList.append(s_lifadian)\r\n    return JsonResponse(lifadianList, safe=False)\r\n\r\n\r\n# 理发师获取首页获取订单-理发师端\r\ndef getOKDingdan(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    the_lifashi = lifashi.objects.get(id=datagetter.get('lifashi_id'))\r\n    zhuangtai_id = int(datagetter.get('zhuangtai_id'))\r\n    dingdanList = []\r\n    for i_dingdan in dingdan.objects.filter(lifashi_id=the_lifashi.id):\r\n        if zhuangtai_id == 1 or zhuangtai_id == 0:\r\n            for i_jiesuan in jiesuandingdan.objects.filter(dingdan_ptr_id=i_dingdan.id):\r\n                if i_jiesuan.shifouzhifu == zhuangtai_id:\r\n                    jieshushijian = str(i_jiesuan.jieshushijian).replace(\"T\", \" \")\r\n                    try:\r\n                        i_fuwu = fuwu.objects.get(id=i_dingdan.fuwuxiang_id)\r\n                        i_yonghu = yonghu.objects.get(id=i_dingdan.yonghu_id)\r\n                        dingdan_detail = {\"dingdan_id\": i_dingdan.id, \"fuwu_name\": i_fuwu.fuwumingcheng,\"price\": i_fuwu.jiage, \"jiesuanshijian\": jieshushijian,\r\n                                         }\r\n                        dingdanList.append(dingdan_detail)\r\n                    except:\r\n                        return JsonResponse({\"status\": 0, \"msg\": \"您还没有已完成的订单\"})\r\n        else:\r\n                for i_yuyue in yuyuedingdan.objects.filter(dingdan_ptr_id=i_dingdan.id):\r\n                    i_fuwu = fuwu.objects.get(id=i_dingdan.fuwuxiang_id)\r\n                    i_yonghu = yonghu.objects.get(id=i_dingdan.yonghu_id)\r\n                    dingdan_detail = {\"yueyu_id\": i_dingdan.id, \"is_ok\":i_yuyue.yijieshou,\"yuyue_start\": i_yuyue.yuyuekaishi,\r\n                                      \"yuyue_xiaohao\": i_yuyue.yuyuexiaohao, \"fuwu_name\": i_fuwu.fuwumingcheng,\"price\": i_fuwu.jiage,\r\n                                      }\r\n                    dingdanList.append(dingdan_detail)\r\n    return JsonResponse(dingdanList, safe=False)\r\n\r\n# 获取理发师信息——理发师端\r\ndef lifashiDetail(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    lianxifangshi = datagetter.get(\"lianxifangshi\")\r\n    the_lifashi = lifashi.objects.get(lianxidianhua=lianxifangshi)\r\n    the_detail = {\"id\":the_lifashi.id, \"name\": the_lifashi.xingming,\r\n                          \"yonghuming\": the_lifashi.yonghuming, \"phone\": the_lifashi.lianxidianhua}\r\n    return JsonResponse(the_detail)\r\n\r\n# 用户提交预约订单——用户端\r\ndef getYuyueOrder(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    yonghudianhua = datagetter.get('yonghu_phone')\r\n    lifashi_id = datagetter.get('lifashi_id')\r\n    fuwu_id = datagetter.get('fuwu_id')\r\n    yuyuekaishi = datagetter.get('select_time')\r\n    lifadian_id = datagetter.get('lifadian_id')\r\n    the_yonghu = yonghu.objects.get(lianxidianhua=yonghudianhua)\r\n    yuyuedingdan.objects.create(yuyuekaishi=yuyuekaishi, lifadian_id=lifadian_id, yonghu=the_yonghu,\r\n                                lifashi_id=lifashi_id, fuwuxiang_id=fuwu_id, yijieshou=0)\r\n    return JsonResponse({\"status\":\"1\",\"data\":\"添加成功\"})\r\n\r\n@csrf_exempt\r\n#用户取消预约\r\ndef CancelOrder(request):\r\n    yuyue_id = request.POST.get(\"dingdan_id\")\r\n    try:\r\n        dingdan.objects.get(id=yuyue_id).delete()\r\n        return JsonResponse({\"status\":0, \"msg\": \"删除成功\"})\r\n    except:\r\n        return JsonResponse({\"status\":1, \"msg\": \"删除失败\"})\r\n\r\n\r\n\r\n# 用户收藏 0-理发店 1-理发师 2-服务——用户端\r\ndef yonghu_shoucang_add(request, shoucangleixing):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    shoucang_id = datagetter.get('shoucang_id')\r\n    i_yonghu = yonghu.objects.get(id=datagetter.get('yonghu_id'))\r\n    shoucang.objects.create(beishoucang_id=shoucang_id, yonghu=i_yonghu, shoucangleixing=shoucangleixing)\r\n    return JsonResponse({\"status\": '1', \"msg\": \"收藏成功\"})\r\n\r\n\r\n# 用户取消收藏 0-理发店 1-理发师 2-服务——用户端\r\ndef yonghu_shoucang_delete(request, shoucangleixing):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    shoucang_id = datagetter.get('shoucang_id')\r\n    i_yonghu = yonghu.objects.get(id=datagetter.get('yonghu_id'))\r\n    print(shoucangleixing)\r\n    try:\r\n        for i_shoucang in shoucang.objects.filter(yonghu=i_yonghu):\r\n            if int(i_shoucang.shoucangleixing) == int(shoucangleixing) and i_shoucang.beishoucang_id == shoucang_id:\r\n                i_shoucang.delete()\r\n                return JsonResponse({\"status\": \"1\", \"msg\": \"删除成功\"})\r\n    except ObjectDoesNotExist:\r\n        return JsonResponse({\"status\": \"0\", \"msg\": \"删除失败1\"})\r\n    return JsonResponse({\"status\": \"0\", \"msg\": \"删除失败\"})\r\n\r\n\r\n# 用户展示收藏 0-理发店 1-理发师 2-服务——用户端\r\ndef yonghu_shoucang_show(request, shoucangleixing):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    i_yonghu = yonghu.objects.get(id=datagetter.get('yonghu_id'))\r\n    shoucang_list = []\r\n    for i_shoucang in shoucang.objects.filter(yonghu=i_yonghu):\r\n        if  shoucangleixing== 0 and int(i_shoucang.shoucangleixing) == shoucangleixing :\r\n            the_lifadian = lifadian.objects.get(id=i_shoucang.beishoucang_id)\r\n            shoucang_detail = {\"lifadian_id\": i_shoucang.beishoucang_id, \"c_id\": i_shoucang.shoucangleixing,\r\n                                   \"lifadian_name\": the_lifadian.dianming, \"phone\": the_lifadian.dianzhulianxi}\r\n            shoucang_list.append(shoucang_detail)\r\n        elif shoucangleixing== 1 and int(i_shoucang.shoucangleixing) == shoucangleixing:\r\n            the_lifashi = lifashi.objects.get(id=i_shoucang.beishoucang_id)\r\n            shoucang_detail = {\"lifashi_id\": i_shoucang.beishoucang_id, \"c_id\": i_shoucang.shoucangleixing,\r\n                                   \"lifashi_name\": the_lifashi.yonghuming, \"phone\": the_lifashi.lianxidianhua}\r\n            shoucang_list.append(shoucang_detail)\r\n        elif shoucangleixing== 2 and int(i_shoucang.shoucangleixing) == shoucangleixing:\r\n            print(i_shoucang.beishoucang_id)\r\n            the_fuwu = fuwu.objects.get(id=i_shoucang.beishoucang_id)\r\n            shoucang_detail = {\"fuwu_id\": i_shoucang.beishoucang_id, \"c_id\": i_shoucang.shoucangleixing,\r\n                                   \"fuwu_name\": the_fuwu.fuwumingcheng, \"price\": the_fuwu.jiage}\r\n            shoucang_list.append(shoucang_detail)\r\n    return JsonResponse(shoucang_list, safe=False)\r\n\r\n\r\n\r\n\r\n\r\n# 得到用户所有订单——用户端(0-未支付， 1-已支付，2 -预约）\r\ndef getYonghuDingdan(request, zhuangtai_id):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    the_yonghu = yonghu.objects.get(id=datagetter.get('yonghu_id'))\r\n    zhuangtai = [\"未支付\", \"已支付\", \"预约\"]\r\n    yonghu_id = the_yonghu.id\r\n    dingdanList = []\r\n    print(yonghu_id)\r\n    for i_dingdan in dingdan.objects.filter(yonghu_id=yonghu_id):\r\n        if zhuangtai_id == 1 or zhuangtai_id == 0:\r\n            for i_jiesuan in jiesuandingdan.objects.filter(dingdan_ptr_id=i_dingdan.id):\r\n                if i_jiesuan.shifouzhifu == zhuangtai_id:\r\n                    try:\r\n                        i_fuwu = fuwu.objects.get(id=i_dingdan.fuwuxiang_id)\r\n                        jiesuanshijian = str(i_jiesuan.jieshushijian).replace(\"T\",\" \")\r\n                        dingdan_detail = {\"dingdan_id\": i_dingdan.id, \"fuwu_name\": i_fuwu.fuwumingcheng, \"zhuangtai\": zhuangtai[zhuangtai_id],\r\n                                          \"price\": i_fuwu.jiage, \"jiesuanshijian\": jiesuanshijian}\r\n                        dingdanList.append(dingdan_detail)\r\n                    except:\r\n                        return JsonResponse({\"status\": 0, \"msg\": \"您还没有已完成的订单\"})\r\n        if zhuangtai_id == 2:\r\n                for i_yuyue in yuyuedingdan.objects.filter(dingdan_ptr_id=i_dingdan.id):\r\n                    print(i_dingdan.id)\r\n                    i_fuwu = fuwu.objects.get(id=i_dingdan.fuwuxiang_id)\r\n                    dingdan_detail = {\"yuyue_id\": i_dingdan.id, \"yuyue_start\": i_yuyue.yuyuekaishi,\"zhuangtai\": zhuangtai[zhuangtai_id],\r\n                                      \"yuyue_xiaohao\": i_yuyue.yuyuexiaohao, \"fuwu_name\": i_fuwu.fuwumingcheng,\"price\": i_fuwu.jiage}\r\n                    dingdanList.append(dingdan_detail)\r\n    return JsonResponse(dingdanList, safe=False)\r\n\r\n#理发师——预约订单总数\r\ndef count_yuyue(request):\r\n    print(request.GET.get(\"yuyuedingdan_id\"))\r\n    id = request.GET.get(\"yuyuedingdan_id\")\r\n    print(id)\r\n    the = yuyuedingdan.objects.get(id=id)\r\n    begin = the.yuyuekaishi\r\n    deadline = the.yuyuekaishi + timezone.timedelta(\r\n        hours=the.yuyuexiaohao.hour,\r\n        minutes=the.yuyuexiaohao.minute,\r\n        seconds=the.yuyuexiaohao.second)\r\n    after = yuyuedingdan.objects.filter(lifadian__lifashi=the.lifashi,yuyuekaishi__gt=begin,yuyuekaishi__lt=deadline,yijieshou=1)\r\n    before = []\r\n    for i in yuyuedingdan.objects.filter(lifadian__lifashi=the.lifashi,yijieshou=1):\r\n        i_deadline = i.yuyuekaishi + timezone.timedelta(\r\n            hours=i.yuyuexiaohao.hour,\r\n            minutes=i.yuyuexiaohao.minute,\r\n            seconds=i.yuyuexiaohao.second)\r\n        if begin <= i_deadline <= deadline:\r\n            before.append(i)\r\n    num =  len(list(set(list(after))  & set(before) ))\r\n    return JsonResponse({\"status\":\"1\",\"msg\":num})\r\n\r\n#理发师获取自己的理发店——理发师端\r\ndef lifashigetLifadian(request, zhuangtaiid):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    i_lifashi = lifashi.objects.get(id=datagetter.get(\"lifashi_id\"))\r\n    i_lifahi_id = i_lifashi.id\r\n    lifadianList = []\r\n    for i_dizhi in jishiqitadizhi.objects.filter(lifashi_id=i_lifahi_id):\r\n        if int(i_dizhi.zhuangtai) == zhuangtaiid :\r\n            the_lifadian = lifadian.objects.get(id=i_dizhi.lifadian_id)\r\n            shenqingshijian = str(i_dizhi.shenqingshijian).replace(\"T\",\" \")\r\n            the_detail = {\"dianzhuming\": the_lifadian.dianzhuming, \"phone\":the_lifadian.dianzhulianxi, \"lifadian_id\": the_lifadian.id,\r\n                              \"name\":the_lifadian.dianming, \"time\":shenqingshijian,\"zhuangtai\":i_dizhi.zhuangtai}\r\n            lifadianList.append(the_detail)\r\n    return JsonResponse(lifadianList, safe=False)\r\n\r\n\r\n#理发师增加其他地址\r\n@csrf_exempt\r\ndef jishidizhi_add(request):\r\n    lifashi_id = request.POST.get(\"lifashi_id\")\r\n    lifadian_id = request.POST.get(\"lifadian_id\")\r\n    jishiqitadizhi.objects.create(lifashi_id=lifashi_id,lifadian_id=lifadian_id,shenqingshijian=timezone.now(),zhuangtai='0')\r\n    return JsonResponse({\"status\":1,\"msg\":\"申请成功\"})\r\n\r\n@csrf_exempt\r\n# 理发师撤销其他地址\r\ndef jishidizhi_delete(request):\r\n    lifashi_id = int(request.POST.get(\"lifashi_id\"))\r\n    lifadian_id = int(request.POST.get('lifadian_id'))\r\n    for i_dizhi in jishiqitadizhi.objects.filter(lifashi_id=lifashi_id):\r\n        if i_dizhi.lifadian_id == lifadian_id:\r\n            i_dizhi.delete()\r\n            break\r\n    return JsonResponse({\"status\":1, \"msg\": \"删除成功\"})\r\n\r\n#理发师增加服务\r\n@csrf_exempt\r\ndef fuwu_add(request):\r\n    lifashi_id = request.POST.get(\"lifashi_id\")\r\n    fuwu_name = request.POST.get(\"fuwu_name\")\r\n    fuwu_leixing = request.POST.get('leixing')\r\n    jiage = request.POST.get(\"jiage\")\r\n    fuwu.objects.create(lifashi_id=lifashi_id, fuwumingcheng=fuwu_name, leixing=fuwu_leixing, jiage=jiage)\r\n    return JsonResponse({\"status\":1,\"msg\":\"增加成功\"})\r\n\r\n@csrf_exempt\r\n# 理发师删除服务\r\ndef fuwu_delete(request):\r\n    fuwu_id = int(request.POST.get('fuwu_id'))\r\n    i_fuwu = fuwu.objects.get(id=fuwu_id)\r\n    i_fuwu.delete()\r\n    return JsonResponse({\"status\":1, \"msg\": \"删除成功\"})\r\n\r\n@csrf_exempt\r\n# 理发师——预约订单详情\r\ndef yuyue_show(request):\r\n    yuyue_id = int(request.POST.get('yuyue_id'))\r\n    i_yuyue = yuyuedingdan.objects.get(id=yuyue_id)\r\n    i_dingdan = dingdan.objects.get(id=yuyue_id)\r\n    i_yonghu = yonghu.objects.get(id=i_dingdan.yonghu_id)\r\n    i_lifashi = lifashi.objects.get(id=i_dingdan.lifashi_id)\r\n    try:\r\n        i_tupian = tupian.objects.get(tupianleixing=\"3\", tupianlaiyuan_id=i_yonghu.id)\r\n        src = i_tupian.src\r\n    except:\r\n        src = \"../../image/默认头像.png\"\r\n    try:\r\n        the_tupian = tupian.objects.get(tupianleixing=\"1\", tupianlaiyuan_id=i_lifashi.id)\r\n        the_src = the_tupian.src\r\n    except:\r\n        the_src = \"../../image/默认头像.png\"\r\n    if i_yuyue.yuyuexiaohao != None:\r\n        gujishijian = i_yuyue.yuyuexiaohao\r\n    else:\r\n        gujishijian =\"00:00\"\r\n    i_fuwu = fuwu.objects.get(id=i_dingdan.fuwuxiang_id)\r\n    i_lifadian = lifadian.objects.get(id=i_dingdan.lifadian_id)\r\n    return JsonResponse({\"yonghuming\":i_yonghu.yonghuming, \"phone\": i_yonghu.lianxidianhua, \"touxiang\": str(src), \"xiaohao\":gujishijian ,\r\n                         \"shifoujieshou\": i_yuyue.yijieshou,\"yuyuekaishi\": i_yuyue.yuyuekaishi,\r\n                         \"lifashi\":{\"lifashi_id\":i_lifashi.id, \"lifashi_name\": i_lifashi.xingming, \"lifashi_phone\": i_lifashi.lianxidianhua, \"touxiang\":str(the_src) },\r\n                         \"fuwu\": i_fuwu.fuwumingcheng, \"lifadian\": i_lifadian.dianming, \"fuwu_price\": i_fuwu.jiage})\r\n\r\n@csrf_exempt\r\n# 理发师——预约订单提交估计时间\r\ndef yuyue_submit(request):\r\n    yuyue_id = int(request.POST.get('yuyue_id'))\r\n    yuyuexiaohao = request.POST.get('yuyuexiaohao')\r\n    i_yuyue = yuyuedingdan.objects.get(id=yuyue_id)\r\n    i_yuyue.yuyuexiaohao=yuyuexiaohao\r\n    i_yuyue.yijieshou = '1'\r\n    i_yuyue.save()\r\n    return JsonResponse({\"status\":1, \"msg\": \"提交成功\"})\r\n\r\n@csrf_exempt\r\n# 理发师——获取已完成订单详情\r\ndef OKdingdan(request):\r\n    dingdan_id = int(request.POST.get('dingdan_id'))\r\n    i_dingdan = dingdan.objects.get(id=dingdan_id)\r\n    i_jiesuan =jiesuandingdan.objects.get(id=i_dingdan.id)\r\n    i_yonghu = yonghu.objects.get(id=i_dingdan.yonghu_id)\r\n    i_lifashi = lifashi.objects.get(id=i_dingdan.lifashi_id)\r\n    shifouzhifu = ['false', 'true']\r\n    try:\r\n        i_tupian = tupian.objects.get(tupianleixing=\"3\", tupianlaiyuan_id=i_yonghu.id)\r\n        src = i_tupian.src\r\n    except:\r\n        src = \"../../image/0.png\"\r\n    try:\r\n        i_lifashi_tupian = tupian.objects.get(tupianleixing=\"1\", tupianlaiyuan_id=i_lifashi.id)\r\n        lifashi_src = i_lifashi_tupian.src\r\n    except:\r\n        lifashi_src = \"../../image/默认头像.png\"\r\n    i_fuwu = fuwu.objects.get(id=i_dingdan.fuwuxiang_id)\r\n    i_lifadian = lifadian.objects.get(id=i_dingdan.lifadian_id)\r\n    try:\r\n        i_pingjia = pingjia.objects.get(dingdan_id=i_dingdan.id)\r\n        is_pingjia = \"true\"\r\n        the_pingjia = {\"pingfen\":i_pingjia.pingfen, \"pingjia\": i_pingjia.pingjia}\r\n    except:\r\n        is_pingjia = 'false'\r\n        the_pingjia = {}\r\n    return JsonResponse({\"dingdan_id\":i_dingdan.id,\"yonghuming\": i_yonghu.yonghuming, \"phone\": i_yonghu.lianxidianhua, \"touxiang\": str(src),\r\n                         \"jiesuanshijian\": i_jiesuan.jieshushijian,\r\n                         \"lifashi\":{ \"lifashi_id\": i_lifashi.id,\"lifashi_phone\":i_lifashi.lianxidianhua,\"lifashi_name\": i_lifashi.xingming,\"lifashi_touxiang\":lifashi_src},\r\n                         \"is_zhifu\": shifouzhifu[i_jiesuan.shifouzhifu], \"fuwu\": i_fuwu.fuwumingcheng,\r\n                         \"lifadian\": i_lifadian.dianming, \"fuwu_price\": i_fuwu.jiage, \"is_pingjia\": is_pingjia,\"pingjia\": the_pingjia})\r\n\r\n#用户——获取理发店信息\r\ndef getLifadian(request):\r\n    lifadian_id = request.GET.get('lifadian_id')\r\n    i_lifadian = lifadian.objects.get(id=lifadian_id)\r\n    try:\r\n        i_dizhi = dizhi.objects.get(lifadian_id=lifadian_id)\r\n        the_dizhi={\"lng\": i_dizhi.lng, \"lat\": i_dizhi.lat}\r\n        dizhi_name = i_dizhi.name\r\n    except:\r\n        the_dizhi={}\r\n        dizhi_name = \"暂无地址信息\"\r\n    lifashiList=[]\r\n    fuwuList = []\r\n    leixing = [\"洗吹\",\"烫发\",\"染发\",\"剪发\",\"护理\"]\r\n    lifadian_tupianList=[]\r\n    for i_lifashi in lifashi.objects.filter(lifadian_id=lifadian_id):\r\n        try:\r\n            lifashi_tupian = tupian.objects.get(tupianleixing=\"1\", tupianlaiyuan_id=i_lifashi.id)\r\n            src = lifashi_tupian.src\r\n        except:\r\n            src=\"../../image/默认头像.png\"\r\n        the_detail = {\"lifashi_id\": i_lifashi.id, \"name\": i_lifashi.yonghuming, \"phone\": i_lifashi.lianxidianhua,\"lifashi_img\": str(src)}\r\n        lifashiList.append(the_detail)\r\n        for i_fuwu in fuwu.objects.filter(lifashi_id=i_lifashi.id):\r\n            the_fuwu = {\"fuwu_id\": i_fuwu.id, \"name\": i_fuwu.fuwumingcheng, \"type\": leixing[int(i_fuwu.leixing)]}\r\n            fuwuList.append(the_fuwu)\r\n    try:\r\n        for i_tupian in tupian.objects.filter(tupianleixing=\"0\", tupianlaiyuan_id=i_lifadian.id):\r\n            the_tupian = {\"tupian_id\": i_tupian.id, \"src\": str(i_tupian.src)}\r\n            lifadian_tupianList.append(the_tupian)\r\n    except:\r\n        lifadian_tupianList = []\r\n    return JsonResponse({\"lifadian_name\": i_lifadian.dianming, \"lifadian_phone\":i_lifadian.dianzhulianxi, \"dizhi\":the_dizhi,\r\n                         \"dizhiming\":dizhi_name, \"lifadian_img\":lifadian_tupianList,\"lifashi\":lifashiList, \"fuwu\": fuwuList})\r\n\r\n\r\n#用户支付函数\r\n@csrf_exempt\r\ndef zhifu(request):\r\n    dingdan_id = request.POST.get('dingdan_id')\r\n    i_dingdan = jiesuandingdan.objects.get(id=dingdan_id)\r\n    i_dingdan.shifouzhifu='1'\r\n    i_dingdan.save()\r\n    return JsonResponse({\"status\": \"1\",\"msg\":\"支付成功\"})\r\n\r\n@csrf_exempt\r\n#用户评价\r\ndef set_pingjia(request):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    try:\r\n        dingdan_id = int(datagetter.get(\"dingdan_id\"))\r\n        i_dingdan = dingdan.objects.get(id=dingdan_id)\r\n        pingfen = datagetter.get(\"score1\")\r\n        pingfen=int(pingfen)\r\n        i_pingjia = datagetter.get(\"text\")\r\n        yonghu_id=dingdan.objects.get(id=dingdan_id).yonghu_id\r\n        i_yonghu = yonghu.objects.get(id=yonghu_id)\r\n        yonghu_id=int(yonghu_id)\r\n        pingjia.objects.create(dingdan=i_dingdan,yonghu=i_yonghu,pingfen=pingfen,pingjia=i_pingjia)\r\n        return JsonResponse({ \"msg\": \"评论成功\"})\r\n    except Exception as e:\r\n        return JsonResponse({\"message\":str(e)})\r\n\r\n@csrf_exempt\r\n#用户添加社区资讯\r\ndef fabuzixun(request):\r\n    yonghu_id = request.POST.get(\"yonghu_id\")\r\n    print(yonghu_id)\r\n    the_neirong = request.POST.get(\"neirong\")\r\n    i_zixun = zixun.objects.create(neirong=the_neirong, yonghu_id=yonghu_id)\r\n    zixun_id = i_zixun.id\r\n    print(zixun_id)\r\n    return JsonResponse({\"staus\":\"发布成功\", \"zixun_id\": zixun_id})\r\n\r\n\r\n#统计数据\r\n@csrf_exempt\r\ndef tongji_yuedu(request):\r\n    yonghu_id = request.POST.get(\"id\")\r\n    the_dingdan = jiesuandingdan.objects.filter(yonghu_id=yonghu_id,jieshushijian__year=timezone.now().year)\r\n    sum_month_res = the_dingdan.annotate(month=ExtractMonth(\"jieshushijian\")).\\\r\n        values(\"month\").order_by(\"month\").annotate(price=Sum('shijifeiyong'))\r\n    data=[0]*12\r\n    for i in sum_month_res:\r\n        data[i['month']-1] = i[\"price\"]\r\n    return JsonResponse({'status':1,\"data\":data})\r\n\r\n@csrf_exempt\r\ndef tongji_leixing(request):\r\n    yonghu_id = request.POST.get(\"id\")\r\n    the_dingdan = jiesuandingdan.objects.filter(yonghu_id=yonghu_id,jieshushijian__year=timezone.now().year)\r\n\r\n    data = {}\r\n\r\n    for i in the_dingdan:\r\n        key = i.fuwuxiang.get_leixing_display()\r\n        data.setdefault(key,0)\r\n        data[key] += i.shijifeiyong\r\n    output= []\r\n    for k,v in data.items():\r\n        output.append({\"name\":k,\"value\":v})\r\n    return JsonResponse({'status': 1, \"data\": output})\r\n\r\n#用户得到社区资讯\r\ndef getZixun(request):\r\n    page = request.GET.get('page')\r\n    start = int(page)*10\r\n    pagesize = int(request.GET.get('pagesize'))\r\n    ZixunList = []\r\n    zixun_len =  zixun.objects.all().count()\r\n    Zixun = zixun.objects.all().order_by('-id')[start:start+pagesize]\r\n    for item in Zixun:\r\n        i_yonghu = item.yonghu\r\n        the_zixun_tupian = tupian.objects.get(tupianlaiyuan_id=item.id, tupianleixing=4)\r\n        zixun_tupian_src = \"http://127.0.0.1:8000/media/\"+the_zixun_tupian.src.name\r\n        the_touxiang_tupian = tupian.objects.get(tupianlaiyuan_id=i_yonghu.id, tupianleixing=3)\r\n        touxiang_tupian_src = the_touxiang_tupian.src.name\r\n        zixun_detail = {\"id\":item.id, \"yonghuming\":i_yonghu.yonghuming, \"yonghu_id\": i_yonghu.id, \"yonghu_touxiang\":touxiang_tupian_src,\r\n                        \"neirong\": item.neirong, \"dianzanshu\": item.dianzanshu, 'fabushijian':item.fabushijian,\r\n                        'zixun_tupian_src':zixun_tupian_src}\r\n        ZixunList.append(zixun_detail)\r\n    return JsonResponse({'zixun':ZixunList,\"pagenum\": int(page)+1,'total':zixun_len})\r\n\r\ndef zhucemibao(request):\r\n    if request.method == \"POST\":\r\n        data_getter = request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter = request.GET\r\n    else:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"注册失败\"})\r\n    shenfen = data_getter.get('shenfen')\r\n    mibaowenti=data_getter.get('mibaowenti')\r\n    mibaodaan=data_getter.get('mibaodaan')\r\n    mibaolaiyuan_id=data_getter.get('mibaolaiyuan_id')\r\n    try:\r\n        mibao.objects.create(shenfen=shenfen,mibaowenti=mibaowenti,mibaodaan=mibaodaan,mibaolaiyuan_id=mibaolaiyuan_id)\r\n        return JsonResponse({\"status\": 1, \"msg\": \"注册成功\"})\r\n    except:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"注册失败\"})\r\n\r\ndef huoqumibao(request):\r\n    if request.method == \"POST\":\r\n        data_getter = request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter = request.GET\r\n    else:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"注册失败\"})\r\n    shenfen=data_getter.get('shenfen')\r\n    mibaolaiyuan_id=data_getter.get('mibaolaiyuan_id')\r\n    try:\r\n        yonghumibao=mibao.objects.get(shenfen=shenfen,mibaolaiyuan_id=mibaolaiyuan_id)\r\n        mibaowenti=yonghumibao.mibaowenti\r\n        mibaodaan=yonghumibao.mibaodaan\r\n        return JsonResponse({\"success\": 1,\"mibaozhuangtai\": 1,\"mibaowenti\": mibaowenti,\"mibaodaan\" :mibaodaan})\r\n    except:\r\n        return JsonResponse({\"success\" :0,\"mibaozhuangtai\" :0,\"msg\" :\"未找到该用户密保，请注册\"})\r\n\r\ndef xiugaimibao(request):\r\n    if request.method == \"POST\":\r\n        data_getter = request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter = request.GET\r\n    else:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"修改失败\"})\r\n    shenfen=data_getter.get('shenfen')\r\n    mibaolaiyuan_id=data_getter.get('mibaolaiyuan_id')\r\n    yuanmibaodaan=data_getter.get('yuanmibaodaan')\r\n    xinmibaowenti=data_getter.get('xinmibaowenti')\r\n    xinmibaodaan=data_getter.get('xinmibaodaan')\r\n    data={\"mibaowenti\": xinmibaowenti,\"mibaodaan\": xinmibaodaan}\r\n    try:\r\n        yonghumibao=mibao.objects.filter(shenfen=shenfen,mibaolaiyuan_id=mibaolaiyuan_id)\r\n        mibaodaan=mibao.objects.filter(shenfen=shenfen,mibaolaiyuan_id=mibaolaiyuan_id)[0].mibaodaan\r\n        print(yonghumibao)\r\n        if yuanmibaodaan==mibaodaan:\r\n            yonghumibao.update(**data)\r\n            return JsonResponse({\"status\": 1, \"msg\": \"修改成功\"})\r\n        else:\r\n            return JsonResponse({\"status\": 2,\"msg\": \"原密保答案错误\",\"yuanmibaodaan\":yuanmibaodaan,\"mibaodaan\":mibaodaan})\r\n    except Exception as e:\r\n        return JsonResponse({\"status\": 0,\"msg\": str(e)})\r\n\r\ndef xiugaimima2(request):\r\n    if request.method == \"POST\":\r\n        data_getter = request.POST\r\n    elif request.method == \"GET\":\r\n        data_getter = request.GET\r\n    else:\r\n        return JsonResponse({\"success\": 0, \"msg\": \"修改失败\"})\r\n    yuanmima=data_getter.get('yuanmima')\r\n    xinmima=data_getter.get('xinmima')\r\n    shenfen=data_getter.get('shenfen')\r\n    lianxidianhua=data_getter.get('lianxidianhua')\r\n    data={\"mima\":xinmima}\r\n    try:\r\n        if shenfen == 'lifashi':\r\n            the_lifashi=lifashi.objects.filter(lianxidianhua=lianxidianhua)\r\n            if the_lifashi[0].mima == yuanmima:\r\n                the_lifashi.update(**data)\r\n                return JsonResponse({\"status\": 1,\"msg\" :\"修改成功\"})\r\n            else:\r\n                return JsonResponse({\"status\": 2,\"msg\": \"密码错误\"})\r\n        else:\r\n            the_yonghu=yonghu.objects.filter(lianxidianhua=lianxidianhua)\r\n            if the_yonghu[0].mima == yuanmima:\r\n                the_yonghu.update(**data)\r\n                return JsonResponse({\"status\": 1, \"msg\": \"修改成功\"})\r\n            else:\r\n                return JsonResponse({\"status\": 2, \"msg\": \"密码错误\"})\r\n    except Exception as e:\r\n        return  JsonResponse({\"status\": 0,\"msg\" :str(e)})\r\n\r\ndef jiageshengxu(list):\r\n    n = len(list)\r\n    # 外层循环控制从头走到尾的次数\r\n    for j in range(n - 1):\r\n        # 用一个count记录一共交换的次数，可以排除已经是排好的序列\r\n        count = 0\r\n        # 内层循环控制走一次的过程\r\n        for i in range(0, n - 1 - j):\r\n            # 如果前一个元素大于后一个元素，则交换两个元素（升序）\r\n            if list[i]['price'] > list[i + 1]['price']:\r\n                # 交换元素\r\n                list[i], list[i + 1] = list[i + 1], list[i]\r\n                # 记录交换的次数\r\n                count += 1\r\n        # count == 0 代表没有交换，序列已经有序\r\n    return list\r\n\r\ndef jiagejiangxu(list):\r\n    n = len(list)\r\n    # 外层循环控制从头走到尾的次数\r\n    for j in range(n - 1):\r\n        # 用一个count记录一共交换的次数，可以排除已经是排好的序列\r\n        count = 0\r\n        # 内层循环控制走一次的过程\r\n        for i in range(0, n - 1 - j):\r\n            # 如果前一个元素小于后一个元素，则交换两个元素（升序）\r\n            if list[i]['price'] < list[i + 1]['price']:\r\n                # 交换元素\r\n                list[i], list[i + 1] = list[i + 1], list[i]\r\n                # 记录交换的次数\r\n                count += 1\r\n        # count == 0 代表没有交换，序列已经有序\r\n    return list\r\n\r\ndef pingfenjiangxu(list):\r\n    n = len(list)\r\n    # 外层循环控制从头走到尾的次数\r\n    for j in range(n - 1):\r\n        # 用一个count记录一共交换的次数，可以排除已经是排好的序列\r\n        count = 0\r\n        # 内层循环控制走一次的过程\r\n        for i in range(0, n - 1 - j):\r\n            # 如果前一个元素小于后一个元素，则交换两个元素（升序）\r\n            if list[i]['pingfen'] < list[i + 1]['pingfen']:\r\n                # 交换元素\r\n                list[i], list[i + 1] = list[i + 1], list[i]\r\n                # 记录交换的次数\r\n                count += 1\r\n        # count == 0 代表没有交换，序列已经有序\r\n    return list\r\n#用户对资讯进行点赞\r\ndef dianzan_zixun(request):\r\n    zixun_id = request.GET.get('zixun_id')\r\n    i_zixun = zixun.objects.get(id=zixun_id)\r\n    dianzanshu = i_zixun.dianzanshu+1\r\n    i_zixun.dianzanshu = dianzanshu\r\n    try:\r\n        i_zixun.save()\r\n        return JsonResponse({\"status\":1,\"msg\":\"点赞成功\"})\r\n    except:\r\n        return JsonResponse({\"status\":0,\"msg\":\"点赞失败\"})\r\n\r\n# 得到理发师所有发型——理发师端(1-短发，2 -烫发， 3 -长发，4 -染发）\r\n@csrf_exempt\r\ndef getFaxing(request, faxing_c_id):\r\n    if request.method == \"POST\":\r\n        datagetter = request.POST\r\n    else:\r\n        datagetter = request.GET\r\n    i_lifashi = lifashi.objects.get(id=datagetter.get(\"lifashi_id\"))\r\n    i_lifashi_id = i_lifashi.id\r\n    faxing_c_id = faxing_c_id\r\n    faxingList = []\r\n    faxing_leixing = {\"1\": \"短发\", \"2\": \"烫发\", \"3\": \"长发\", \"4\": \"染发\"}\r\n    for i_faxing in faxing.objects.filter(lifashi_id = i_lifashi_id,leixing=faxing_c_id):\r\n        imageList = []\r\n        for i_image in tupian.objects.filter(tupianlaiyuan_id=i_faxing.id,tupianleixing=\"2\"):\r\n            if \"https://\" in str(i_image.src):\r\n                i_image.src = str(i_image.src)\r\n            else:\r\n                i_image.src = \"http://127.0.0.1:8000/media/\"+str(i_image.src)\r\n            imgae_detail = {\"image_id\": i_image.id, \"image_src\": str(i_image.src)}\r\n            imageList.append(imgae_detail)\r\n        faxing_detail = {\"id\": i_faxing.id, \"c_id\": i_faxing.leixing,\r\n                                     \"c_name\": faxing_leixing[i_faxing.leixing], \"f_name\": i_faxing.faxingming,\r\n                                     \"f_beizhu\": i_faxing.beizhu, \"image\": imageList}\r\n        faxingList.append(faxing_detail)\r\n    return JsonResponse(faxingList, safe=False)\r\n\r\n#理发师添加发型\r\n@csrf_exempt\r\ndef faxing_add(request):\r\n    lifashi_id = request.POST.get(\"lifashi_id\")\r\n    faxing_name = request.POST.get(\"mingcheng\")\r\n    faxing_leixing = request.POST.get('leixing')\r\n    faxing_xinxi = request.POST.get(\"xinxi\")\r\n    i_faxing= faxing.objects.create(lifashi_id = lifashi_id, faxingming = faxing_name, leixing = faxing_leixing, beizhu = faxing_xinxi)\r\n    faxing_id = i_faxing.id\r\n    print(faxing_id)\r\n    return JsonResponse({\"staus\": \"添加成功\", \"faxing_id\": faxing_id})\r\n\r\n\r\nimport random\r\ndef get_random_code(length=4):\r\n    \"\"\"获得随机字符串\"\"\"\r\n    code = ''\r\n    choice_str = '0123456789'\r\n    for _ in range(length):\r\n        random_str = random.choice(choice_str)\r\n        code += random_str\r\n    return code\r\n\r\n#找回密码 0=用户 1=理发师\r\nfrom django.conf import settings\r\nfrom django.core.mail import send_mail\r\ndef fasongyouxiang(request,shenfen):\r\n    \"\"\"type=1 找回密码\"\"\"\r\n    _type = request.GET.get(\"type\")\r\n    lianxifangshi = request.GET.get(\"lianxifangshi\")\r\n    \"\"\"发送邮件\"\"\"\r\n    email_rcode = EmailVerifyRecord()\r\n    from_email = settings.DEFAULT_FROM_EMAIL\r\n    # 忘记密码发送验证邮件, 和 发送验证码逻辑一样\r\n    if shenfen==0:\r\n        try:\r\n            i_yonghu = yonghu.objects.get(lianxidianhua=lianxifangshi)\r\n            email = i_yonghu.email\r\n        except:\r\n            return JsonResponse({\"status\":\"0\", \"msg\":\"用户不存在\"})\r\n    else:\r\n        try:\r\n            i_yonghu = lifashi.objects.get(lianxidianhua=lianxifangshi)\r\n            email = i_yonghu.email\r\n        except:\r\n            return JsonResponse({\"status\":\"0\", \"msg\":\"用户不存在\"})\r\n    if _type == '1':\r\n        random_code = get_random_code()\r\n        email_title = '找回密码'\r\n        email_body = '您的验证码为：'+random_code\r\n        # 保存验证码\r\n        email_rcode.code = random_code\r\n        email_rcode.send_type = _type\r\n        email_rcode.email = email\r\n        email_rcode.yonghu = i_yonghu\r\n        email_rcode.save()\r\n        # 真正启动Django自带的发送邮件功能，邮件标题，邮件内容，发送人，发给谁，发送成功则返回1，失败则返回0\r\n        email_status = send_mail(subject=email_title, message=email_body, from_email=from_email, recipient_list=[email])\r\n        return HttpResponse(email_status)\r\n\r\n#找回密码，验证验证码 0=用户 1=理发师\r\ndef checkyanzhengma(request, shenfen):\r\n    lianxifangshi = request.GET.get(\"lianxifangshi\")\r\n    the_code = request.GET.get(\"code\")\r\n    if shenfen==0:\r\n        i_yonghu = yonghu.objects.get(lianxidianhua=lianxifangshi)\r\n    else:\r\n        i_yonghu = lifashi.objects.get(lianxidianhua=lianxifangshi)\r\n    print(i_yonghu)\r\n    email_rcode = EmailVerifyRecord.objects.get(yonghu=i_yonghu)\r\n    code = email_rcode.code\r\n    if the_code == code:\r\n        email_rcode.delete()\r\n        return JsonResponse({\"status\":\"1\",\"msg\":\"验证码一致\"})\r\n    else:\r\n        return JsonResponse({\"status\":\"0\",\"msg\":\"验证码错误\"})\r\n\r\n#重置密码，验证验证码 0=用户 1=理发师\r\n@csrf_exempt\r\ndef xiugaimima(request, shenfen):\r\n    lianxifangshi = request.POST.get(\"lianxifangshi\")\r\n    new_mima = request.POST.get(\"mima\")\r\n    try:\r\n        if shenfen==0:\r\n                i_yonghu = yonghu.objects.get(lianxidianhua=lianxifangshi)\r\n                i_yonghu.mima = new_mima\r\n                i_yonghu.save()\r\n        else:\r\n                i_yonghu = lifashi.objects.get(lianxidianhua=lianxifangshi)\r\n                i_yonghu.mima = new_mima\r\n                i_yonghu.save()\r\n        return JsonResponse({\"status\":\"true\",\"msg\":\"修改成功\"})\r\n    except:\r\n        return JsonResponse({\"status\":\"false\",\"msg\":\"修改失败\"})\r\n\r\n\r\n\r\n#统计理发师数据\r\n@csrf_exempt\r\ndef lifashi_tongji_yuedu(request):\r\n    lifashi_id = request.POST.get(\"id\")\r\n    the_dingdan = jiesuandingdan.objects.filter(lifashi_id=lifashi_id,jieshushijian__year=timezone.now().year)\r\n    sum_month_res = the_dingdan.annotate(month=ExtractMonth(\"jieshushijian\")).\\\r\n        values(\"month\").order_by(\"month\").annotate(price=Sum('shijifeiyong'))\r\n    data=[0]*12\r\n    for i in sum_month_res:\r\n        data[i['month']-1] = i[\"price\"]\r\n    return JsonResponse({'status':1,\"data\":data})\r\n\r\n@csrf_exempt\r\ndef lifashi_tongji_leixing(request):\r\n    lifashi_id = request.POST.get(\"id\")\r\n    the_dingdan = jiesuandingdan.objects.filter(lifashi_id=lifashi_id,jieshushijian__year=timezone.now().year)\r\n    data = {}\r\n    for i in the_dingdan:\r\n        key = i.fuwuxiang.get_leixing_display()\r\n        data.setdefault(key,0)\r\n        data[key] += i.shijifeiyong\r\n    output= []\r\n    for k,v in data.items():\r\n        output.append({\"name\":k,\"value\":v})\r\n    return JsonResponse({'status': 1, \"data\": output})
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- jianyue/view/lifashi_yonghu.py	(revision 939fd3853ca86a1463d8cd7a9676ff1615d18754)
+++ jianyue/view/lifashi_yonghu.py	(date 1608019963699)
@@ -6,7 +6,7 @@
 from django.http import JsonResponse,HttpResponse
 from django.utils import timezone
 from ..models import yonghu, lifashi, lifadian, fuwu, EmailVerifyRecord,jiesuandingdan, pingjia, dingdan, jishiqitadizhi, faxing, tupian, \
-    yuyuedingdan, shoucang, dizhi, zixun, mibao
+    yuyuedingdan, shoucang, dizhi, zixun,mibao
 from django.db.utils import IntegrityError
 from django.core.exceptions import ObjectDoesNotExist
 from django.views.decorators.csrf import csrf_exempt
